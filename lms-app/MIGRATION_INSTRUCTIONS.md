# Инструкция по миграции базы данных для поддержки множественных курсов

## Проблема
Текущая схема базы данных не позволяет студенту быть зачисленным на несколько курсов одновременно. В таблице `students` есть поле `course_id`, что ограничивает студента одним курсом.

## Решение
Создана новая схема с таблицей `student_courses` для связи "многие ко многим" между студентами и курсами.

## Шаги миграции

### 1. Создание новой схемы
Файл `database/schema_multi_course.sql` содержит полную новую схему с поддержкой множественных курсов.

### 2. Миграция существующих данных
Файл `database/migration_to_multi_course.sql` содержит скрипт для миграции существующих данных.

### 3. Выполнение миграции

#### Вариант A: Полная пересоздание базы (для разработки)
```bash
# Удалить существующую базу
npx wrangler d1 delete DB

# Создать новую базу
npx wrangler d1 create smj-lms-db

# Обновить wrangler.jsonc с новым database_id

# Применить новую схему
npx wrangler d1 execute DB --file=./database/schema_multi_course.sql --remote
```

#### Вариант B: Миграция существующих данных (для продакшена)
```bash
# Выполнить миграцию пошагово
npx wrangler d1 execute DB --file=./database/migration_to_multi_course.sql --remote
```

### 4. Обновление кода
- Обновлены модели в `src/models/database.ts`
- Обновлен `DatabaseService` в `src/utils/database.ts`
- Добавлены новые методы для работы с `student_courses`

## Новые возможности

### Для студентов:
- Зачисление на несколько курсов одновременно
- Отдельный прогресс по каждому курсу
- Возможность отчисления с курса без удаления студента

### Для админов:
- Просмотр всех курсов студента
- Управление зачислением/отчислением
- Детальная статистика по курсам

## Новые API методы

### Student Courses:
- `getStudentCourses(studentId)` - получить все курсы студента
- `enrollStudentInCourse(data)` - зачислить студента на курс
- `unenrollStudentFromCourse(studentId, courseId)` - отчислить с курса
- `getStudentsByCourse(courseId)` - получить всех студентов курса
- `getStudentProgress(studentId, courseId)` - получить прогресс студента по курсу

## Важные изменения в логике

### Telegram Bot:
- При входе студента показываются все его курсы
- Прогресс рассчитывается отдельно для каждого курса
- Студент может переключаться между курсами

### Admin Panel:
- Отображение всех курсов студента
- Возможность зачисления/отчисления с курсов
- Детальная статистика по каждому курсу

## Проверка миграции

После миграции проверьте:
1. Все существующие студенты сохранились
2. Связи с курсами перенесены в таблицу `student_courses`
3. Новые методы работают корректно
4. Telegram бот показывает все курсы студента 