<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMJ LMS - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav {
            background: white;
            border-bottom: 1px solid #e1e5e9;
            padding: 0 2rem;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
        }

        .nav-item {
            padding: 1rem 0;
            color: #666;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .nav-item:hover {
            color: #667eea;
        }

        .main {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 500;
            color: #555;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 1px solid #e1e5e9;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.approved {
            background: #d4edda;
            color: #155724;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status.rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status.not-submitted {
            background: #e2e3e5;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header-content,
            .nav-content,
            .main {
                padding: 0 1rem;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .table-container {
                overflow-x: auto;
            }

            .table th,
            .table td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üéì SMJ LMS - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <div class="user-info">
                <span>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                <a href="#" class="logout-btn" onclick="logout()">üö™ –í—ã–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-content">
            <a href="#" class="nav-item active" onclick="showPage('dashboard')">üìä –ì–ª–∞–≤–Ω–∞—è</a>
            <a href="#" class="nav-item" onclick="showPage('students')">üë• –°—Ç—É–¥–µ–Ω—Ç—ã</a>
            <a href="#" class="nav-item" onclick="showPage('courses')">üìö –ö—É—Ä—Å—ã</a>
            <a href="#" class="nav-item" onclick="showPage('reports')">üìù –û—Ç—á–µ—Ç—ã</a>
            <a href="#" class="nav-item" onclick="showPage('logs')">üìã –õ–æ–≥–∏</a>
        </div>
    </div>

    <div class="main">
        <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –æ—Ç—á–µ—Ç–æ–º -->
        <div id="dashboard-page">
            <div class="page-header">
                <h2 class="page-title">üìä –û—Ç—á–µ—Ç –ø–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º</h2>
                <button class="btn" onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-students">-</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-courses">-</div>
                    <div class="stat-label">–ö—É—Ä—Å–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-reports">-</div>
                    <div class="stat-label">–û—Ç—á–µ—Ç–æ–≤ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-lessons">-</div>
                    <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤</div>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>–ì–æ—Ä–æ–¥:</label>
                        <select id="city-filter" onchange="applyFilters()">
                            <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>–ö—É—Ä—Å:</label>
                        <select id="course-filter" onchange="applyFilters()">
                            <option value="">–í—Å–µ –∫—É—Ä—Å—ã</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>–°—Ç–∞—Ç—É—Å:</label>
                        <select id="status-filter" onchange="applyFilters()">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="approved">–û–¥–æ–±—Ä–µ–Ω–æ</option>
                            <option value="pending">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</option>
                            <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                            <option value="not-submitted">–ù–µ —Å–¥–∞–Ω–æ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-secondary" onclick="clearFilters()">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ -->
            <div class="table-container">
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...</p>
                </div>
                <div id="error" class="error" style="display: none;"></div>
                <table class="table" id="students-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>–ì–æ—Ä–æ–¥</th>
                            <th>–°—Ç—É–¥–µ–Ω—Ç</th>
                            <th>–ö—É—Ä—Å</th>
                            <th id="lessons-header">–£—Ä–æ–∫–∏</th>
                            <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                        </tr>
                    </thead>
                    <tbody id="students-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∑–∞–≥–ª—É—à–∫–∏) -->
        <div id="students-page" style="display: none;">
            <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏</h2>
            <p>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
        </div>

        <div id="courses-page" style="display: none;">
            <h2>üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏</h2>
            <p>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
        </div>

        <div id="reports-page" style="display: none;">
            <h2>üìù –†–µ—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤</h2>
            <p>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
        </div>

        <div id="logs-page" style="display: none;">
            <h2>üìã –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
            <p>–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let studentsData = [];
        let coursesData = [];
        let reportsData = [];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                window.location.href = '/';
                return;
            }
            
            await loadData();
        });

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth/check`, {
                    credentials: 'include'
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function loadData() {
            showLoading(true);
            hideError();

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
                const [studentsResponse, coursesResponse, reportsResponse] = await Promise.all([
                    fetch(`${API_BASE}/students`, { credentials: 'include' }),
                    fetch(`${API_BASE}/courses`, { credentials: 'include' }),
                    fetch(`${API_BASE}/reports`, { credentials: 'include' })
                ]);

                if (!studentsResponse.ok || !coursesResponse.ok || !reportsResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                studentsData = await studentsResponse.json();
                coursesData = await coursesResponse.json();
                reportsData = await reportsResponse.json();

                await renderDashboard();
                updateStats();
                populateFilters();

            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function renderDashboard() {
            const tbody = document.getElementById('students-tbody');
            const lessonsHeader = document.getElementById('lessons-header');
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            tbody.innerHTML = '';
            
            // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–∫–æ–≤
            const maxLessons = Math.max(...coursesData.courses.map(course => 
                course.lessons ? course.lessons.length : 0
            ));

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–æ–≤
            let lessonsHeaderHtml = '';
            for (let i = 1; i <= maxLessons; i++) {
                lessonsHeaderHtml += `<th>–£—Ä–æ–∫ ${i}</th>`;
            }
            lessonsHeader.innerHTML = lessonsHeaderHtml;

            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É
            const studentsByCity = {};
            studentsData.students.forEach(student => {
                if (!studentsByCity[student.city]) {
                    studentsByCity[student.city] = [];
                }
                studentsByCity[student.city].push(student);
            });

            // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            Object.keys(studentsByCity).sort().forEach(city => {
                studentsByCity[city].forEach(student => {
                    const course = coursesData.courses.find(c => c.id === student.course_id);
                    const studentReports = reportsData.reports.filter(r => r.student_id === student.id);
                    
                    const row = document.createElement('tr');
                    
                    // –ì–æ—Ä–æ–¥
                    const cityCell = document.createElement('td');
                    cityCell.textContent = city;
                    row.appendChild(cityCell);
                    
                    // –°—Ç—É–¥–µ–Ω—Ç
                    const studentCell = document.createElement('td');
                    studentCell.textContent = student.name;
                    row.appendChild(studentCell);
                    
                    // –ö—É—Ä—Å
                    const courseCell = document.createElement('td');
                    courseCell.textContent = course ? course.title : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    row.appendChild(courseCell);
                    
                    // –£—Ä–æ–∫–∏
                    if (course && course.lessons) {
                        course.lessons.forEach(lesson => {
                            const lessonCell = document.createElement('td');
                            const report = studentReports.find(r => r.lesson_id === lesson.id);
                            
                            if (report) {
                                const statusClass = report.status;
                                const statusText = getStatusText(report.status);
                                lessonCell.innerHTML = `<span class="status ${statusClass}">${statusText}</span>`;
                            } else {
                                lessonCell.innerHTML = '<span class="status not-submitted">–ù–µ —Å–¥–∞–Ω–æ</span>';
                            }
                            
                            row.appendChild(lessonCell);
                        });
                    }
                    
                    // –ü—Ä–æ–≥—Ä–µ—Å—Å
                    const progressCell = document.createElement('td');
                    const completed = studentReports.filter(r => r.status === 'approved').length;
                    const total = course ? course.lessons.length : 0;
                    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                    progressCell.textContent = `${completed}/${total} (${percentage}%)`;
                    row.appendChild(progressCell);
                    
                    tbody.appendChild(row);
                });
            });

            document.getElementById('students-table').style.display = 'table';
        }

        function getStatusText(status) {
            switch (status) {
                case 'approved': return '‚úÖ –°–¥–∞–ª';
                case 'pending': return '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞';
                case 'rejected': return '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω';
                default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        }

        function updateStats() {
            document.getElementById('total-students').textContent = studentsData.students.length;
            document.getElementById('total-courses').textContent = coursesData.courses.length;
            document.getElementById('pending-reports').textContent = reportsData.reports.filter(r => r.status === 'pending').length;
            
            const completedLessons = reportsData.reports.filter(r => r.status === 'approved').length;
            document.getElementById('completed-lessons').textContent = completedLessons;
        }

        function populateFilters() {
            // –ì–æ—Ä–æ–¥–∞
            const cities = [...new Set(studentsData.students.map(s => s.city))].sort();
            const cityFilter = document.getElementById('city-filter');
            cityFilter.innerHTML = '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                cityFilter.appendChild(option);
            });

            // –ö—É—Ä—Å—ã
            const courseFilter = document.getElementById('course-filter');
            courseFilter.innerHTML = '<option value="">–í—Å–µ –∫—É—Ä—Å—ã</option>';
            coursesData.courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = course.title;
                courseFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const cityFilter = document.getElementById('city-filter').value;
            const courseFilter = document.getElementById('course-filter').value;
            const statusFilter = document.getElementById('status-filter').value;

            const rows = document.querySelectorAll('#students-tbody tr');
            
            rows.forEach(row => {
                const city = row.cells[0].textContent;
                const courseId = getCourseIdFromRow(row);
                const lessonStatuses = getLessonStatusesFromRow(row);
                
                let show = true;
                
                if (cityFilter && city !== cityFilter) show = false;
                if (courseFilter && courseId !== courseFilter) show = false;
                if (statusFilter && !lessonStatuses.includes(statusFilter)) show = false;
                
                row.style.display = show ? '' : 'none';
            });
        }

        function getCourseIdFromRow(row) {
            const studentName = row.cells[1].textContent;
            const student = studentsData.students.find(s => s.name === studentName);
            return student ? student.course_id : null;
        }

        function getLessonStatusesFromRow(row) {
            const statuses = [];
            for (let i = 3; i < row.cells.length - 1; i++) {
                const statusElement = row.cells[i].querySelector('.status');
                if (statusElement) {
                    statuses.push(statusElement.className.split(' ')[1]);
                }
            }
            return statuses;
        }

        function clearFilters() {
            document.getElementById('city-filter').value = '';
            document.getElementById('course-filter').value = '';
            document.getElementById('status-filter').value = '';
            applyFilters();
        }

        function refreshData() {
            loadData();
        }

        function showPage(pageName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.querySelectorAll('[id$="-page"]').forEach(page => {
                page.style.display = 'none';
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            document.getElementById(pageName + '-page').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
                window.location.href = '/';
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function hideLoading() {
            showLoading(false);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
    </script>
</body>
</html> 